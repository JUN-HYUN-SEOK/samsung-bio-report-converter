import pandas as pd
from openpyxl.styles import PatternFill
import streamlit as st
import traceback
from datetime import datetime
import io

# Streamlit í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ì‚¼ì„±ë°”ì´ì˜¤ ë ˆí¬íŠ¸ ë³€í™˜ê¸°",
    page_icon="ğŸ“Š",
    layout="wide"
)

mapping_dict = {
    "ì‹ ê³ ë²ˆí˜¸": "ì‹ ê³ ë²ˆí˜¸",
    "ì‹ ì²­ì°¨ìˆ˜": "ì •ì •ì°¨ìˆ˜",
    "ì‹ ê³ ì¼ì": "ì‹ ê³ ì¼ì",
    "ì ‘ìˆ˜ì¼ì": "ì‹ ê³ ì¼ì",
    "ìˆ˜ë¦¬ì¼ì": "ìˆ˜ë¦¬ì¼ì",
    "ì„¸ê´€": "ì‹ ê³ ì„¸ê´€",
    "ê³¼": "ì‹ ê³ ê³¼",
    "MasterB/Lë²ˆí˜¸": "MasterB/Lë²ˆí˜¸",
    "B/L(AWB)ë²ˆí˜¸": "B/Lë²ˆí˜¸",
    "B/Lë¶„í• ì—¬ë¶€": "B/Lêµ¬ë¶„",
    "í™”ë¬¼ê´€ë¦¬ë²ˆí˜¸": "í™”ë¬¼ê´€ë¦¬ë²ˆí˜¸",
    "ì…í•­ì¼ì": "ì…í•­ì¼ì",
    "ë°˜ì…ì¼ì": "ë°˜ì…ì¼ì",
    "ì§•ìˆ˜í˜•íƒœ": "ì§•ìˆ˜í˜•íƒœ",
    "ìˆ˜ì…ììƒí˜¸": "ìˆ˜ì…ììƒí˜¸",
    "ë‚©ì„¸ì˜ë¬´ììƒí˜¸": "ë‚©ì„¸ììƒí˜¸",
    "ë‚©ì„¸ì˜ë¬´ìëŒ€í‘œì": "ë‚©ì„¸ìëŒ€í‘œìëª…",
    "ë‚©ì„¸ì˜ë¬´ìì‚¬ì—…ë²ˆí˜¸": "ë‚©ì„¸ìì‚¬ì—…ë²ˆí˜¸",
    "ë¬´ì—­ê±°ë˜ì²˜ìƒí˜¸": "ë¬´ì—­ê±°ë˜ì²˜ìƒí˜¸",
    "ë¬´ì—­ê±°ë˜ì²˜ë¶€í˜¸": "ë¬´ì—­ê±°ë˜ì²˜ì½”ë“œ",
    "ë¬´ì—­ê±°ë˜ì²˜êµ­ê°€": "ë¬´ì—­ê±°ë˜ì²˜êµ­ê°€ì½”ë“œ",
    "í•´ì™¸ê³µê¸‰ììƒí˜¸": "í•´ì™¸ê³µê¸‰ììƒí˜¸",
    "í•´ì™¸ê³µê¸‰ìë¶€í˜¸": "í•´ì™¸ê³µê¸‰ìì½”ë“œ",
    "í•´ì™¸ê³µê¸‰ìêµ­ê°€": "í•´ì™¸ê³µê¸‰ìêµ­ê°€ì½”ë“œ",
    "í†µê´€ê³„íšë¶€í˜¸": "í†µê´€ê³„íš",
    "ì‹ ê³ êµ¬ë¶„ë¶€í˜¸": "ì‹ ê³ êµ¬ë¶„",
    "ê±°ë˜êµ¬ë¶„ë¶€í˜¸": "ê±°ë˜êµ¬ë¶„",
    "ìˆ˜ì…ì¢…ë¥˜ë¶€í˜¸": "ìˆ˜ì…ì¢…ë¥˜",
    "ì»¨í…Œì´ë„ˆë²ˆí˜¸": "ì»¨í…Œì´ë„ˆë²ˆí˜¸",
    "ì›ì‚°ì§€ì¦ëª…ì„œìœ ë¬´": "ì›ì‚°ì§€ì¦ëª…ìœ ë¬´",
    "ê°€ê²©ì‹ ê³ ì„œìœ ë¬´": "ê°€ê²©ì‹ ê³ ì„œìœ ë¬´",
    "ì´ì¤‘ëŸ‰": "ì´ì¤‘ëŸ‰",
    "ì´ìˆ˜ëŸ‰": "í™˜ê¸‰ë¬¼ëŸ‰",
    "ì´í™˜ê¸‰ë¬¼ëŸ‰": "í™˜ê¸‰ë¬¼ëŸ‰",
    "ì´í¬ì¥ê°¯ìˆ˜": "ì´í¬ì¥ìˆ˜ëŸ‰",
    "ì´í¬ì¥ì¢…ë¥˜": "í¬ì¥ìˆ˜ëŸ‰ë‹¨ìœ„",
    "êµ­ë‚´ë„ì°©í•­ë¶€í˜¸": "ë„ì°©í•­ì½”ë“œ",
    "ìš´ì†¡í˜•íƒœìˆ˜ë‹¨": "ìš´ì†¡í˜•íƒœ",
    "ìš´ì†¡í˜•íƒœìš©ê¸°": "ìš´ì†¡ìš©ê¸°",
    "ì ì¶œêµ­ë¶€í˜¸": "ì ì¶œêµ­ì½”ë“œ",
    "ì„ (ê¸°)ëª…": "ì„ ê¸°ëª…_1",
    "ìš´ìˆ˜ê¸°ê´€ë¶€í˜¸": "ìš´ìˆ˜ê¸°ê´€",
    "ê²€ì‚¬ì¥ì¹˜ì¥ì†Œë¶€í˜¸": "ì¥ì¹˜ì¥ë¶€í˜¸",
    "ê²€ì‚¬(ë°˜ì…)ì¥ì†Œë¶€í˜¸": "ì¥ì¹˜ì¥ì†Œ",
    "ê²€ì‚¬(ë°˜ì…)ì¥ì†Œì¥ì†Œëª…": "ì¥ì¹˜ì¥ëª…",
    "ì´ë€ìˆ˜": "ì´ë€ìˆ˜",
    "ì¸ë„ì¡°ê±´": "ì¸ë„ì¡°ê±´",
    "ê²°ì œí†µí™”": "ê²°ì œí†µí™”ë‹¨ìœ„",
    "ê²°ì œí™˜ìœ¨": "ê²°ì œí†µí™”ë‹¨ìœ„í™˜ìœ¨",
    "ë¯¸í™”í™˜ìœ¨": "USDí™˜ìœ¨",
    "ê²°ì œì´ê¸ˆì•¡": "ì…ë ¥ê²°ì œê¸ˆì•¡",
    "ê²°ì¬ë°©ë²•": "ê²°ì œë°©ë²•",
    "ê²°ì œê¸ˆì•¡": "ì…ë ¥ê²°ì œê¸ˆì•¡",
    "ê¸°íƒ€ê¸ˆì•¡": "ê¸°íƒ€ê¸ˆì•¡",
    "ì´ê³¼ì„¸ê°€ê²©ë¯¸í™”": "Cifë‹¬ëŸ¬",
    "ì´ê³¼ì„¸ê°€ê²©ì›í™”": "Cifì›í™”",
    "ìš´ì„ì›í™”": "ê³„ì‚°ëœìš´ì„ì›í™”",
    "ìš´ì„1 í†µí™”ì¢…ë¥˜": "ìš´ì„í†µí™”ë‹¨ìœ„",
    "ìš´ì„1 ì‚¬ìš©ìê¸°ì¬": None,
    "ìš´ì„2 í†µí™”ì¢…ë¥˜": "ìš´ì„í†µí™”ë‹¨ìœ„",
    "ìš´ì„2 ì‚¬ìš©ìê¸°ì¬": None,
    "ë³´í—˜ì›í™”": "ê³„ì‚°ëœë³´í—˜ë£Œì›í™”",
    "ë³´í—˜ë£Œ1 í†µí™”ì¢…ë¥˜": None,
    "ë³´í—˜ë£Œ1 ì‚¬ìš©ìê¸°ì¬": None,
    "ê°€ì‚°ê¸ˆì•¡ì›í™”ë€ë¡œì—´í‹°í•©": "ì „ì²´ê³„ì‚°ëœê°€ì‚°ê¸ˆì›í™”",
    "ê°€ì‚°ê¸ˆì•¡ êµ¬ë¶„(ìœ¨,ê¸ˆì•¡)": "ê°€ì‚°ê¸ˆêµ¬ë¶„",
    "ê°€ì‚°ê¸ˆì•¡ í†µí™”ì¢…ë¥˜": "ê°€ì‚°ê¸ˆí†µí™”ë‹¨ìœ„",
    "ê°€ì‚°ë¹„ìš©/ìœ¨": "ì…ë ¥ê°€ì‚°ê¸ˆ",
    "ê°€ì‚°ê¸ˆì•¡ í†µí™”ì¢…ë¥˜_1": "ê°€ì‚°ê¸ˆí†µí™”ë‹¨ìœ„",
    "ê°€ì‚°ë¹„ìš©/ìœ¨_1": None,
    "ê°€ì‚°ê¸ˆì•¡ ì›í™”(ë¡œì—´í‹° ì œì™¸)": "ê³µí†µì‚¬í•­ê³„ì‚°ëœê°€ì‚°ê¸ˆì›í™”",
    "ê³µì œê¸ˆì•¡ì›í™”": "ê³µí†µì‚¬í•­ê³„ì‚°ëœê³µì œê¸ˆì›í™”",
    "ê³µì œê¸ˆì•¡ êµ¬ë¶„(ìœ¨,ê¸ˆì•¡ê³„ì‚°)": "ê³µì œê¸ˆêµ¬ë¶„",
    "ê³µì œê¸ˆì•¡ í†µí™”ì¢…ë¥˜": "ê³µì œê¸ˆí†µí™”ë‹¨ìœ„",
    "ê³µì œê¸ˆì•¡/ìœ¨": "ì…ë ¥ê³µì œê¸ˆ",
    "ì´ê´€ì„¸": "ê´€ì„¸",
    "ì´ê°œì†Œì„¸": "íŠ¹ì†Œì„¸",
    "ì´ì£¼ì„¸": "ì£¼ì„¸",
    "ì´êµí†µì„¸": "êµí†µì„¸",
    "ì´êµìœ¡ì„¸": "êµìœ¡ì„¸",
    "ì´ë†íŠ¹ì„¸": "ë†íŠ¹ì„¸",
    "ì´ë¶€ê°€ì„¸": "ë¶€ê°€ì„¸",
    "ì´ì‹ ê³ ì§€ì—°ê°€ì‚°ì„¸": "ì‹ ê³ ì§€ì—°ê°€ì‚°ì„¸",
    "ì´ì„¸ì•¡í•©ê³„": "ì´ì„¸ì•¡",
    "ë¶€ê°€ì„¸ê³¼ì„¸ê³¼í‘œ": "ë¶€ê°€ì„¸ê³¼ì„¸ê³¼í‘œ",
    "ë¶€ê°€ì„¸ë©´ì„¸ê³¼í‘œ": "ë¶€ê°€ì„¸ë©´ì„¸ê³¼í‘œ",
    "íŠ¹ì†¡ì—…ì²´ì½”ë“œ": "íŠ¹ì†¡ì—…ì²´ì½”ë“œ",
    "ì‹ ê³ ì¸ê¸°ì¬ë€1": "ê´€ì„¸ì‚¬ê¸°ì¬2_01",
    "ì‹ ê³ ì¸ê¸°ì¬ë€2": "ê´€ì„¸ì‚¬ê¸°ì¬2_02",
    "ì‹ ê³ ì¸ê¸°ì¬ë€3": "ê´€ì„¸ì‚¬ê¸°ì¬2_03",
    "ì‹ ê³ ì¸ê¸°ì¬ë€4": "ê´€ì„¸ì‚¬ê¸°ì¬2_04",
    "ì‹ ê³ ì¸ê¸°ì¬ë€5": "ê´€ì„¸ì‚¬ê¸°ì¬2_05",
    "ì‹ ê³ ì¸ê¸°ì¬ë€6": "ê´€ì„¸ì‚¬ê¸°ì¬2_06",
    "ì‹ ê³ ì¸ê¸°ì¬ë€7": "ê´€ì„¸ì‚¬ê¸°ì¬2_07",
    "ì‹ ê³ ì¸ê¸°ì¬ë€8": "ê´€ì„¸ì‚¬ê¸°ì¬2_08",
    "ì‹ ê³ ì¸ê¸°ì¬ë€9": "ê´€ì„¸ì‚¬ê¸°ì¬2_09",
    "ì‹¬ì‚¬ë‹´ë‹¹ìì„±ëª…": "ì„¸ê´€ë‹´ë‹¹ìì´ë¦„",
    "ì‹¬ì‚¬ë‹´ë‹¹ìì§ì›ë¶€í˜¸": "ì„¸ê´€ë‹´ë‹¹ìë¶€í˜¸",
    "ìˆ˜ì‹ ê²°ê³¼": "ìˆ˜ì‹ ê²°ê³¼",
    "ìˆ˜ì…ì˜ë¢°ë²ˆí˜¸": None,
    "ì‹ ê³ ììƒí˜¸": "ì‹ ê³ ììƒí˜¸",
    "BLë¶„í• ì‚¬ìœ ì½”ë“œ": "B/Lë¶„í• ì‚¬ìœ ì½”ë“œ",
    "BLë¶„í• ê¸°íƒ€ì‚¬ìœ ": "ê¸°íƒ€ì‚¬ìœ ",
    "ë³´ì„¸ê³µì¥ì‚¬ìš©ì‹ ê³ êµ¬ë¶„": "ì‚¬ìš©ì‹ ê³ êµ¬ë¶„",
    "ë³´ì„¸ê³µì¥ì‚¬ìš©ì‹ ê³ ì„¤ëª…": None,
    "ë³´ì„¸ê³µì¥ì‚¬ìš©ì¼ì": "ì‚¬ìš©ì‹ ê³ ì¼ì",
    "ëŒ€í–‰ì‚¬ì½”ë“œ": "ëŒ€í–‰ì‚¬ì½”ë“œ",
    "ëŒ€í–‰ì‚¬ìƒí˜¸": "ëŒ€í–‰ì‚¬ìƒí˜¸",
    "ìš´ì†¡ì£¼ì„ ì¸ë¶€í˜¸": "ìš´ì†¡ì£¼ì„ ì¸ì½”ë“œ",
    "ìš´ì†¡ì£¼ì„ ì¸ìƒí˜¸": "ìš´ì†¡ì£¼ì„ ì¸ìƒí˜¸",
    "ì„¸ê´€ê¸°ì¬ë€": "ì„¸ê´€ê¸°ì¬ë€",
    "ë€ë²ˆí˜¸": "ë€ë²ˆí˜¸2",
    "ì„¸ë²ˆë¶€í˜¸": "ì„¸ë²ˆë¶€í˜¸",
    "í‘œì¤€í’ˆëª…(ë¯¸ì „ì†¡)": None,
    "í‘œì¤€í’ˆëª…ì½”ë“œ": "í‘œì¤€í’ˆëª…ì½”ë“œ",
    "í’ˆëª…1": "í‘œì¤€í’ˆëª…",
    "í’ˆëª…2": None,
    "ê±°ë˜í’ˆëª…1": "ê±°ë˜í’ˆëª…",
    "ê±°ë˜í’ˆëª…2": None,
    "ìƒí‘œì½”ë“œ": "ìƒí‘œì½”ë“œ",
    "ìƒí‘œëª…": "ìƒí‘œëª…",
    "ì²¨ë¶€ì—¬ë¶€": "ì²¨ë¶€",
    "ì‹ ê³ ê°€ê²©": "ë€ê²°ì œê¸ˆì•¡",
    "ê³¼ì„¸ê°€ê²©(ì›í™”)": "ê³¼ì„¸ê°€ê²©ì›í™”",
    "ê³¼ì„¸ê°€ê²© ë¯¸í™”": "ê³¼ì„¸ê°€ê²©ë‹¬ëŸ¬",
    "ìˆœì¤‘ëŸ‰": "ìˆœì¤‘ëŸ‰",
    "ìˆœì¤‘ëŸ‰ë‹¨ìœ„": "ìˆœì¤‘ëŸ‰ë‹¨ìœ„",
    "ìˆ˜ëŸ‰": "ìˆ˜ëŸ‰",
    "ìˆ˜ëŸ‰ë‹¨ìœ„": "ìˆ˜ëŸ‰ë‹¨ìœ„",
    "í™˜ê¸‰ë¬¼ëŸ‰": "í™˜ê¸‰ë¬¼ëŸ‰",
    "í™˜ê¸‰ë¬¼ëŸ‰ë‹¨ìœ„": "í™˜ê¸‰ë¬¼ëŸ‰ë‹¨ìœ„",
    "C/S ê²€ì‚¬êµ¬ë¶„ ë¶€í˜¸": "CSê²€ì‚¬",
    "ê²€ì‚¬ë°©ë²•ë³€ê²½ ë¶€í˜¸": None,
    "ì›ì‚°ì§€êµ­ê°€ë¶€í˜¸": "ì›ì‚°ì§€ì´ë¦„",
    "ì›ì‚°ì§€ê²°ì •ê¸°ì¤€": "ì›ì‚°ì§€í‘œì‹œê²°ì •ë°©ë²•",
    "ì›ì‚°ì§€í‘œì‹œìœ ë¬´": "ì›ì‚°ì§€í‘œì‹œìœ ë¬´",
    "ì›ì‚°ì§€í‘œì‹œë°©ë²•": "ì›ì‚°ì§€í‘œì‹œë°©ë²•",
    "ì›ì‚°ì§€ë°œí–‰ë²ˆí˜¸": "ì›ì‚°ì§€ì¦ëª…ì„œë°œê¸‰ë²ˆí˜¸",
    "ì›ì‚°ì§€ë°œí–‰ì¼ì": "ì›ì‚°ì§€ì¦ëª…ì„œë°œê¸‰ì¼ì",
    "ì›ì‚°ì§€ë°œí–‰êµ­ê°€": "ì›ì‚°ì§€ì¦ëª…ì„œë°œê¸‰êµ­ê°€",
    "ì›ì‚°ì§€ë°œí–‰ê¸°ê´€": "ì›ì‚°ì§€ì¦ëª…ì„œë°œê¸‰ê¸°ê´€",
    "ì›ì‚°ì§€ë°œê¸‰ì§€ì—­": "ì›ì‚°ì§€ì¦ëª…ì„œë°œê¸‰ì§€ì—­",
    "ì›ì‚°ì§€ë°œê¸‰ë‹´ë‹¹ì": "ì›ì‚°ì§€ì¦ëª…ì„œë°œê¸‰ë‹´ë‹¹ì",
    "ì›ì‚°ì§€ê¸°ì¤€": "ì›ì‚°ì§€ì¦ëª…ì„œì›ì‚°ì§€ê¸°ì¤€",
    "ì›ì‚°ì§€ë¶„í• ì—¬ë¶€": "ì›ì‚°ì§€ì¦ëª…ì„œë°œí–‰ë²ˆí˜¸ë¶„í• ì—¬ë¶€",
    "ê°€ì‚°ë¹„ìš©": "ë€ì…ë ¥ê°€ì‚°ê¸ˆ",
    "ê³µì œë¹„ìš©": None,
    "ì„¸ì¢…ë¶€í˜¸": "ì„¸ìœ¨ì„¤ëª…",
    "ê´€ì„¸êµ¬ë¶„": "ì„¸ìœ¨êµ¬ë¶„",
    "ê´€ì„¸ìœ¨": "ê´€ì„¸ì‹¤í–‰ì„¸ìœ¨",
    "íƒ„ë ¥ê´€ì„¸êµ¬ë¶„": "íƒ„ë ¥êµ¬ë¶„",
    "íƒ„ë ¥ê´€ì„¸ìœ¨": "íƒ„ë ¥ì‹¤í–‰ì„¸ìœ¨",
    "ë‹¨ìœ„ë‹¹ ì„¸ì•¡": None,
    "ê´€ì„¸ê°ë©´ìœ¨": "ê´€ì„¸ê°ë©´ìœ¨",
    "ê´€ì„¸ì•¡": "ì‹¤ì œê´€ì„¸ì•¡",
    "ê´€ì„¸ê°ë©´ì•¡": "ê²½ê°ê´€ì„¸",
    "ê´€ì„¸ê°ë©´/ë¶„ë‚©ë¶€í˜¸": "ê´€ì„¸ê°ë©´ë¶„ë‚©ë¶€í˜¸",
    "ê´€ì„¸ê°ë©´/ë¶„ë‚©êµ¬ë¶„": "ê´€ì„¸ê°ë©´êµ¬ë¶„",
    "ì „ì†¡ìš©ì„¸ìœ¨/ë‹¨ìœ„ë‹¹ì„¸ì•¡": "ê´€ì„¸ì‹¤í–‰ì„¸ìœ¨",
    "ë‚´êµ­ì„¸ êµ¬ë¶„": "ë‚´êµ­ì„¸êµ¬ë¶„",
    "ë‚´êµ­ì„¸ ì„¸ì¢…êµ¬ë¶„": "ë‚´êµ­ì„¸êµ¬ë¶„",
    "ë‚´êµ­ì„¸ ë¶€í˜¸": "ë‚´êµ­ì„¸ë¶€í˜¸",
    "ë‚´êµ­ì„¸ìœ¨": "ë‚´êµ­ì„¸ìœ¨",
    "ë‚´êµ­ì„¸ ê°ë©´ì•¡": "ë‚´êµ­ì„¸ë©´ì„¸",
    "ë‚´êµ­ì„¸": "ë‚´êµ­ì„¸_1",
    "ê°œì†Œì„¸ ë©´ì„¸ë¶€í˜¸": "íŠ¹ì†Œì„¸ë©´ì„¸ë¶€í˜¸",
    "ê°œì†Œì„¸ ê¸°ì¤€ê°€ê²© ê³µì œ": "íŠ¹ì†Œì„¸",
    "ê°œì†Œì„¸": "íŠ¹ì†Œì„¸",
    "êµí†µì„¸": "êµìœ¡ì„¸_1",
    "ì£¼ì„¸": "ì£¼ì„¸",
    "êµìœ¡ì„¸ êµ¬ë¶„": "êµìœ¡ì„¸êµ¬ë¶„",
    "êµìœ¡ì„¸ ì„¸ì¢…êµ¬ë¶„": None,
    "êµìœ¡ì„¸ ê°ë©´ì•¡": "ë‚´êµ­ì„¸ë©´ì„¸",
    "êµìœ¡ì„¸ ìœ¨": "êµìœ¡ì„¸ìœ¨",
    "êµìœ¡ì„¸": "êµìœ¡ì„¸",
    "ë†íŠ¹ì„¸êµ¬ë¶„": "ë†íŠ¹ì„¸êµ¬ë¶„",
    "ë†íŠ¹ì„¸ì„¸ì¢…ë¶€í˜¸": None,
    "ë†íŠ¹ì„¸": "ë†íŠ¹ì„¸",
    "ë†íŠ¹ì„¸ìœ¨": "ë†íŠ¹ì„¸ì„¸ìœ¨",
    "ë¶€ê°€ì„¸ ìœ¨": None,
    "ë¶€ê°€ì„¸ êµ¬ë¶„": "ë¶€ê°€ì„¸êµ¬ë¶„",
    "ë¶€ê°€ì„¸ ì„¸ì¢…ë¶€í˜¸": None,
    "ë¶€ê°€ì„¸": "ë¶€ê°€ì„¸_1",
    "ë¡œì—´í‹° êµ¬ë¶„": None,
    "ë¡œì—´í‹° ìœ¨": None,
    "ë¡œì—´í‹° ê¸ˆì•¡": None,
    "ê³µì œë¹„ìš© ì›í™”": "ê³µì œë¹„ìš©ì›í™”",
    "ë¶€ê°€ì„¸ê°ë©´ë¶€í˜¸": "ë¶€ê°€ì„¸ê°ë©´ë¶€í˜¸",
    "ë¶€ê°€ì„¸ ê°ë©´ì•¡": "ë©´ì„¸ë¶€ê°€ì„¸",
    "ë¶€ê°€ì„¸ ê°ë©´ìœ¨": "ë¶€ê°€ì„¸ê²½ê°ìœ¨",
    "ê´€ì„¸ì•¡ ê¸°ì¤€": None,
    "ë¶€ê°€ì„¸ ê³¼ì„¸ê³¼í‘œ": "ë¶€ê°€ì„¸ê³¼í‘œ",
    "ë¶€ê°€ì„¸ ë©´ì„¸ê³¼í‘œ": "ë¶€ê°€ì„¸ë©´ì„¸ê³¼í‘œ_1",
    "ìš©ë„ì„¸ìœ¨ê³µë¬¸ë²ˆí˜¸": "ìš©ë„ì„¸ìœ¨ì „ìš©ë¬¼í’ˆí™•ì¸ê³µë¬¸ë²ˆí˜¸",
    "ì´ê·œê²©ìˆ˜": "ì´ê·œê²©ìˆ˜",
    "ì´ìš”ê±´í™•ì¸ì„œë¥˜ìˆ˜": "ìš”ê±´í™•ì¸ì„œë¥˜ìˆ˜",
    "ì´ì¬ìˆ˜ì¶œì„œë¥˜ìˆ˜": None,
    "ì´ìš”ê±´ë¹„ëŒ€ìƒì„œë¥˜ìˆ˜": None,
    "ì´ê·œê²©ìˆ˜_1": "ì´ê·œê²©ìˆ˜",
    "ê·œê²©ë²ˆí˜¸": "í–‰ë²ˆí˜¸",
    "ìì¬ì½”ë“œ": "ìì¬ì½”ë“œ",
    "ê·œê²©1": "ê·œê²©1",
    "ê·œê²©2": "ê·œê²©2",
    "ê·œê²©3": "ê·œê²©3",
    "ì„±ë¶„1": "ì„±ë¶„1",
    "ì„±ë¶„2": "ì„±ë¶„2",
    "ê·œê²©ìˆ˜ëŸ‰": "ìˆ˜ëŸ‰_1",
    "ê·œê²©ë‹¨ìœ„": "ìˆ˜ëŸ‰ë‹¨ìœ„_1",
    "ê·œê²©ë‹¨ê°€": "ë‹¨ê°€",
    "ê·œê²©ê¸ˆì•¡": "ê¸ˆì•¡",
    "ì •ì •ì‹ ì²­ì¼ì": None,
    "ì •ì •ìŠ¹ì¸ì¼ì": None,
    "ì •ì •ì‹ ì²­êµ¬ë¶„": None,
    "ì •ì •ì‚¬ìœ ì½”ë“œ": None,
    "ì •ì •ì‚¬ìœ ì½”ë“œëª…": None,
    "ì •ì •ì°¨ìˆ˜": "ì •ì •ì°¨ìˆ˜",
    "ì „ì†¡ê²°ê³¼": "ì „ì†¡ê²°ê³¼",
    "ì‹ ê·œì‘ì„±ì": None,
    "ìµœì¢…ìˆ˜ì •ì": None,
    "ê°€ê²©ì‹ ê³ _ì†¡í’ˆì¥ë²ˆí˜¸": None,
    "ê°€ê²©ì‹ ê³ _ì†¡í’ˆì¥ë°œí–‰ì¼": None,
    "ê°€ê²©ì‹ ê³ _ì ì •ê°€ê²©ì‹ ê³ ë²ˆí˜¸": None,
    "ê°€ê²©ì‹ ê³ _ê°€ê²©í™•ì •ì˜ˆì •ì‹œê¸°": None,
    "ì…ë ¥ì¼ì": "ì…ë ¥ì¼ì‹œ",
}


def log_error(message, e=None):
    st.error(f"[ì˜¤ë¥˜] {message}")
    if e:
        st.error(f"  - ì˜¤ë¥˜ ìœ í˜•: {type(e).__name__}")
        st.error(f"  - ì˜¤ë¥˜ ë‚´ìš©: {str(e)}")
        with st.expander("ìƒì„¸ ì˜¤ë¥˜ ì •ë³´"):
            traceback_str = ''.join(traceback.format_tb(e.__traceback__))
            st.code(traceback_str)


def log_info(message):
    st.info(f"[ì •ë³´] {message}")


def log_success(message):
    st.success(f"[ì™„ë£Œ] {message}")


# Streamlit UI
def main():
    st.title("ğŸ“Š ì‚¼ì„±ë°”ì´ì˜¤ ë ˆí¬íŠ¸ ë³€í™˜ê¸°")
    st.markdown("---")
    
    # íŒŒì¼ ì—…ë¡œë“œ
    st.subheader("1. RAW ë°ì´í„° íŒŒì¼ ì—…ë¡œë“œ")
    uploaded_file = st.file_uploader(
        "Excel íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš” (.xlsx, .xls)",
        type=['xlsx', 'xls'],
        help="RAW ë°ì´í„°ê°€ í¬í•¨ëœ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”."
    )
    
    if uploaded_file is not None:
        try:
            # íŒŒì¼ ì •ë³´ í‘œì‹œ
            st.success(f"âœ… íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ: {uploaded_file.name}")
            
            # ë°ì´í„° ë¡œë“œ (ëª¨ë“  ì»¬ëŸ¼ì„ ë¬¸ìì—´ë¡œ ì½ì–´ì„œ ì•ì˜ 0 ë³´ì¡´)
            with st.spinner("ğŸ“‚ RAW ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘..."):
                raw_df = pd.read_excel(uploaded_file, sheet_name=0, dtype=str)
                raw_df = raw_df.dropna(axis=1, how='all')
            
            log_success(f"RAW ë°ì´í„° ë¡œë“œ ì™„ë£Œ (í–‰: {len(raw_df)}, "
                       f"ì—´: {len(raw_df.columns)})")
            
            # ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
            st.subheader("2. ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
            with st.expander("ì›ë³¸ ë°ì´í„° í™•ì¸", expanded=False):
                st.dataframe(raw_df.head(10), use_container_width=True)
                st.caption(f"ì´ {len(raw_df)}í–‰, {len(raw_df.columns)}ì—´")
            
            # ë§¤í•‘ ì²˜ë¦¬
            with st.spinner("ğŸ”„ ë§¤í•‘ ë”•ì…”ë„ˆë¦¬ë¥¼ ì ìš© ì¤‘..."):
                data = {}
                raw_headers = []
                
                progress_bar = st.progress(0)
                total_cols = len(mapping_dict)
                
                for idx, (customer_col, raw_col) in enumerate(
                    mapping_dict.items()
                ):
                    try:
                        if raw_col in [None, "#N/A"]:
                            data[customer_col] = [""] * len(raw_df)
                            raw_headers.append("")
                        else:
                            if raw_col in raw_df.columns:
                                # ì›ë³¸ ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš© (dtype=strë¡œ ì½ì—ˆê¸° ë•Œë¬¸ì— ì´ë¯¸ ë¬¸ìì—´)
                                data[customer_col] = raw_df[raw_col].fillna("")
                                raw_headers.append(raw_col)
                            else:
                                data[customer_col] = [""] * len(raw_df)
                                raw_headers.append("")
                    except Exception as e:
                        log_error(f"ì»¬ëŸ¼ '{customer_col}' ë§¤í•‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e)
                        data[customer_col] = [""] * len(raw_df)
                        raw_headers.append("")
                    
                    # ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                    progress_bar.progress((idx + 1) / total_cols)
                
                progress_bar.empty()
            
            # ìµœì¢… ë°ì´í„°í”„ë ˆì„ ìƒì„±
            with st.spinner("âš™ï¸ ë°ì´í„° ë³€í™˜ ì¤‘..."):
                final_df = pd.DataFrame(data)
                
                # íŠ¹ì • ì»¬ëŸ¼ì˜ ì•ìª½ 0 ì œê±° (ìˆ«ìë¡œë§Œ ì´ë£¨ì–´ì§„ ê²½ìš°)
                columns_to_strip_zeros = ['ì§•ìˆ˜í˜•íƒœ', 'ìš´ì†¡í˜•íƒœìˆ˜ë‹¨']
                for col in columns_to_strip_zeros:
                    if col in final_df.columns:
                        def strip_leading_zeros(value):
                            if pd.isna(value) or value == "":
                                return value
                            # ë¬¸ìì—´ë¡œ ë³€í™˜
                            str_value = str(value).strip()
                            # ìˆ«ìë¡œë§Œ ì´ë£¨ì–´ì§„ ê²½ìš°ì—ë§Œ ì•ì˜ 0 ì œê±°
                            if str_value.isdigit() and len(str_value) > 1:
                                return str_value.lstrip('0') or '0'  # ëª¨ë‘ 0ì¸ ê²½ìš° '0' ë°˜í™˜
                            return str_value
                        final_df[col] = final_df[col].apply(strip_leading_zeros)
                
                # ì‹ ê³ ì¼ìë³„ë¡œ ì •ë ¬ (ë¹ ë¥¸ ë‚ ì§œê°€ ìœ„ë¡œ)
                if 'ì‹ ê³ ì¼ì' in final_df.columns:
                    # ë‚ ì§œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì •ë ¬
                    final_df['ì‹ ê³ ì¼ì_sort'] = pd.to_datetime(final_df['ì‹ ê³ ì¼ì'], errors='coerce')
                    final_df = final_df.sort_values('ì‹ ê³ ì¼ì_sort', ascending=True)
                    final_df = final_df.drop('ì‹ ê³ ì¼ì_sort', axis=1)
                    final_df = final_df.reset_index(drop=True)
                
                # NO ì»¬ëŸ¼ ì¶”ê°€ (ì„±ëŠ¥ ê²½ê³  í•´ê²°)
                no_column = pd.Series(range(1, len(final_df) + 1), name='NO')
                final_df = pd.concat([no_column, final_df], axis=1)
                
                # raw_headersì—ë„ NO ì»¬ëŸ¼ ì¶”ê°€
                raw_headers.insert(0, "NO")
            
            log_success(f"ìµœì¢… ë°ì´í„°í”„ë ˆì„ ìƒì„± ì™„ë£Œ (í–‰: {len(final_df)}, "
                       f"ì—´: {len(final_df.columns)})")
            
            # ë³€í™˜ëœ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
            st.subheader("3. ë³€í™˜ëœ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
            with st.expander("ë³€í™˜ëœ ë°ì´í„° í™•ì¸", expanded=True):
                st.dataframe(final_df.head(10), use_container_width=True)
                st.caption(f"ì´ {len(final_df)}í–‰, {len(final_df.columns)}ì—´")
            
            # ë‹¤ìš´ë¡œë“œ ì„¹ì…˜
            st.subheader("4. ê²°ê³¼ íŒŒì¼ ë‹¤ìš´ë¡œë“œ")
            
            if st.button("ğŸ“¥ ì—‘ì…€ íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ", 
                        type="primary", use_container_width=True):
                with st.spinner("ğŸ“Š ì—‘ì…€ íŒŒì¼ì„ ìƒì„± ì¤‘..."):
                    # ì„ì‹œ íŒŒì¼ ìƒì„±
                    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                    temp_filename = f"ì‚¼ì„±ë°”ì´ì˜¤_ë³´ê³ ì„œ_ê²°ê³¼_{timestamp}.xlsx"
                    
                    # ë©”ëª¨ë¦¬ì—ì„œ ì—‘ì…€ íŒŒì¼ ìƒì„±
                    output = io.BytesIO()
                    
                    with pd.ExcelWriter(output, engine='openpyxl') as writer:
                        # raw_headersë¥¼ ì²« ë²ˆì§¸ í–‰ìœ¼ë¡œ ì¶”ê°€
                        headers_df = pd.DataFrame(
                            [raw_headers], columns=final_df.columns
                        )
                        combined_df = pd.concat(
                            [headers_df, final_df], ignore_index=True
                        )
                        combined_df.to_excel(
                            writer, index=False, sheet_name='ë°ì´í„°'
                        )
                        
                        # ìŠ¤íƒ€ì¼ ì ìš©
                        worksheet = writer.sheets['ë°ì´í„°']
                        yellow_fill = PatternFill(
                            start_color='FFFF00', 
                            end_color='FFFF00', 
                            fill_type='solid'
                        )
                        yellow_columns = ['ì‹ ê³ ë²ˆí˜¸', 'ì •ì •ì°¨ìˆ˜', 
                                        'ì‹ ê³ ì¼ì', 'ìˆ˜ë¦¬ì¼ì']
                        
                        # 2ë²ˆì§¸ í–‰ì´ ì‹¤ì œ í—¤ë”
                        for col_idx, header in enumerate(worksheet[2], 1):
                            if header.value in yellow_columns:
                                for row in worksheet.iter_rows(
                                    min_row=3, max_row=worksheet.max_row,
                                    min_col=col_idx, max_col=col_idx
                                ):
                                    row[0].fill = yellow_fill
                            
                            # í…ìŠ¤íŠ¸ í˜•ì‹ ì§€ì • (ëª¨ë“  ì»¬ëŸ¼)
                            for row in worksheet.iter_rows(
                                min_row=3, max_row=worksheet.max_row,
                                min_col=col_idx, max_col=col_idx
                            ):
                                row[0].number_format = '@'
                    
                    output.seek(0)
                    
                    st.download_button(
                        label="ğŸ’¾ ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ",
                        data=output.getvalue(),
                        file_name=temp_filename,
                        mime="application/vnd.openxmlformats-"
                             "officedocument.spreadsheetml.sheet",
                        use_container_width=True
                    )
                    
                    log_success("ì—‘ì…€ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!")
                    st.balloons()
            
        except Exception as e:
            log_error("íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤", e)
    
    else:
        st.info("ğŸ‘† ìœ„ì—ì„œ RAW ë°ì´í„° íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
        
        # ì‚¬ìš© ë°©ë²• ì•ˆë‚´
        with st.expander("ğŸ“– ì‚¬ìš© ë°©ë²•", expanded=True):
            st.markdown("""
            ### ì‚¬ìš© ë‹¨ê³„:
            1. **RAW ë°ì´í„° íŒŒì¼ ì—…ë¡œë“œ**: Excel íŒŒì¼(.xlsx, .xls)ì„ 
               ì„ íƒí•˜ì„¸ìš”
            2. **ë°ì´í„° í™•ì¸**: ì—…ë¡œë“œëœ ì›ë³¸ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ë³´ê¸°ë¡œ 
               í™•ì¸í•˜ì„¸ìš”
            3. **ë³€í™˜ ê²°ê³¼ í™•ì¸**: ë§¤í•‘ì´ ì ìš©ëœ ë³€í™˜ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”
            4. **ë‹¤ìš´ë¡œë“œ**: ë³€í™˜ëœ ì—‘ì…€ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”
            
            ### íŠ¹ì§•:
            - âœ… ìë™ ë§¤í•‘ ì ìš©
            - âœ… ìŠ¤íƒ€ì¼ ì§€ì • (ë…¸ë€ìƒ‰ í•˜ì´ë¼ì´íŠ¸)
            - âœ… ì›ë³¸ ë°ì´í„° ê°’ 100% ê·¸ëŒ€ë¡œ ìœ ì§€ (ì•ì˜ 0 í¬í•¨)
            - âœ… ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ ì‹¤í–‰
            """)
        
        # ë³€í™˜ ë¡œì§ ì„¤ëª… ì¶”ê°€
        with st.expander("ğŸ”§ ë³€í™˜ ë¡œì§ ì„¤ëª…", expanded=False):
            st.markdown("""
            ### ğŸ“Š ë°ì´í„° ë³€í™˜ í”„ë¡œì„¸ìŠ¤:
            
            #### 1ï¸âƒ£ **íŒŒì¼ ì½ê¸° & ì „ì²˜ë¦¬**
            ```python
            # Excel íŒŒì¼ì„ ëª¨ë“  ì»¬ëŸ¼ ë¬¸ìì—´ë¡œ ë¡œë“œ (ì•ì˜ 0 ë³´ì¡´)
            raw_df = pd.read_excel(uploaded_file, dtype=str)
            # ë¹ˆ ì»¬ëŸ¼ ì œê±°
            raw_df = raw_df.dropna(axis=1, how='all')
            ```
            
            #### 2ï¸âƒ£ **ë§¤í•‘ ë”•ì…”ë„ˆë¦¬ ì ìš©**
            ```python
            # ë¯¸ë¦¬ ì •ì˜ëœ 244ê°œ ì»¬ëŸ¼ ë§¤í•‘
            mapping_dict = {
                "ì‹ ê³ ë²ˆí˜¸": "ì‹ ê³ ë²ˆí˜¸",
                "ì‹ ì²­ì°¨ìˆ˜": "ì •ì •ì°¨ìˆ˜", 
                "ì„¸ê´€": "ì‹ ê³ ì„¸ê´€",
                # ... ì´ 244ê°œ ë§¤í•‘ ê·œì¹™
            }
            ```
            
            #### 3ï¸âƒ£ **ë°ì´í„° ë³€í™˜**
            ```python
            # ì›ë³¸ ê°’ì„ ê·¸ëŒ€ë¡œ ìœ ì§€ (ì´ë¯¸ ë¬¸ìì—´ë¡œ ì½ìŒ)
            raw_df[raw_col].fillna("")
            # "020" â†’ "020" (ë³€ê²½ ì—†ìŒ)
            # "00" â†’ "00" (ë³€ê²½ ì—†ìŒ)
            ```
            
            #### 4ï¸âƒ£ **ì—‘ì…€ ìŠ¤íƒ€ì¼ ì ìš©**
            ```python
            # ë…¸ë€ìƒ‰ í•˜ì´ë¼ì´íŠ¸ (ì¤‘ìš” ì»¬ëŸ¼)
            yellow_columns = ['ì‹ ê³ ë²ˆí˜¸', 'ì •ì •ì°¨ìˆ˜', 'ì‹ ê³ ì¼ì', 'ìˆ˜ë¦¬ì¼ì']
            
            # ëª¨ë“  ì»¬ëŸ¼ì„ í…ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì €ì¥ (@)
            row[0].number_format = '@'
            ```
            
            #### 5ï¸âƒ£ **ìµœì¢… ì¶œë ¥**
            - **1í–‰**: RAW ë°ì´í„° ì›ë³¸ í—¤ë”ëª…
            - **2í–‰**: ë³€í™˜ëœ ê³ ê°ì‚¬ í—¤ë”ëª…  
            - **3í–‰~**: ë³€í™˜ëœ ì‹¤ì œ ë°ì´í„° (ì›ë³¸ ê°’ 100% ê·¸ëŒ€ë¡œ)
            - **NO ì»¬ëŸ¼**: ìë™ ìƒì„±ëœ í–‰ ë²ˆí˜¸ (1ë¶€í„° ì‹œì‘)
            
            ---
            
            ### ğŸ¯ **í•µì‹¬ íŠ¹ì§•:**
            - **244ê°œ ì»¬ëŸ¼** ìë™ ë§¤í•‘ ì²˜ë¦¬
            - **ì‹¤ì‹œê°„ ì§„í–‰ë¥ ** í‘œì‹œ (ì§„í–‰ ë°”)
            - **ì˜¤ë¥˜ ì²˜ë¦¬**: ëˆ„ë½ëœ ì»¬ëŸ¼ë„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
            - **ì„±ëŠ¥ ìµœì í™”**: pd.concat() ì‚¬ìš©ìœ¼ë¡œ ë¹ ë¥¸ ì²˜ë¦¬
            - **ìŠ¤íƒ€ì¼ ì ìš©**: ì—…ë¬´ì— í•„ìš”í•œ ì‹œê°ì  ê°•ì¡°
            - **ì›ë³¸ ê°’ 100% ë³´ì¡´**: ëª¨ë“  ë°ì´í„°ë¥¼ ì›ë³¸ ê·¸ëŒ€ë¡œ ìœ ì§€
            
            ### ğŸ” **ë°ì´í„° í’ˆì§ˆ ë³´ì¥:**
            - **NULL ê°’ ì²˜ë¦¬**: ë¹ˆ ë¬¸ìì—´ë¡œ í†µì¼
            - **ì•ì˜ 0 ë³´ì¡´**: "020" â†’ "020", "00" â†’ "00"
            - **ì›ë³¸ ê°’ ìœ ì§€**: dtype=strë¡œ ì½ì–´ ëª¨ë“  ê°’ ê·¸ëŒ€ë¡œ ë³´ì¡´
            - **RAW í—¤ë” ë³´ì¡´**: ì›ë³¸ í—¤ë” ì •ë³´ ìœ ì§€
            """)


if __name__ == "__main__":
    main()
